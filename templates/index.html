<!DOCTYPE html>
<html lang="zh-TW" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨å¤§æˆ¶å‹•å‘åˆ†æå ±è¡¨ - å°ˆæ¥­çœ‹ç›¤ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            background-color: #0d0d0d;
            color: #dcdcdc;
        }

        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
            background: #161616;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.8);
        }

        .table {
            border-color: #333;
        }

        .table th {
            background-color: #1f1f1f !important;
            color: #f0f0f0 !important;
            text-align: center;
            vertical-align: middle;
            white-space: nowrap;
            border-bottom: 2px solid #555;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .table .sub-header th {
            background-color: #111111 !important;
            color: #aaaaaa !important;
            font-size: 0.9rem;
            border-bottom: 1px solid #333;
        }

        .table td {
            text-align: right;
            vertical-align: middle;
            white-space: nowrap;
            border-color: #2b2b2b;
        }

        .table .text-center {
            text-align: center;
        }

        .table .text-left {
            text-align: left;
        }

        /* Professional Stock Terminal Colors */
        .th-buy {
            background-color: #5a1a1a !important;
            border-bottom: 2px solid #ff4d4d !important;
            color: #ffcccc !important;
        }

        .th-sell {
            background-color: #1a4a1a !important;
            border-bottom: 2px solid #4dff4d !important;
            color: #ccffcc !important;
        }

        .bg-red-light {
            background-color: #3a1c1c !important;
            color: #ff7b7b !important;
        }

        .bg-red-dark {
            background-color: #7b1a1a !important;
            color: #ffb3b3 !important;
        }

        .bg-green-light {
            background-color: #1c3a1c !important;
            color: #7bff7b !important;
        }

        .bg-green-dark {
            background-color: #1a6b1a !important;
            color: #b3ffb3 !important;
        }

        .hover-bg-yellow {
            background-color: #3d3511 !important;
            color: #ffe600 !important;
            transition: all 0.2s;
        }

        .stock-clickable {
            cursor: pointer;
            position: relative;
        }

        .stock-clickable:hover::after {
            content: ' \1F50D';
            position: absolute;
            right: 4px;
            font-size: 0.85em;
            opacity: 0.8;
        }

        .header-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #161616;
            border-radius: 8px;
            border: 1px solid #333;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
        }

        /* Custom Dark Scrollbar */
        ::-webkit-scrollbar {
            height: 10px;
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #0d0d0d;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        .nav-pills .nav-link {
            color: #aaa;
        }

        .nav-pills .nav-link.active {
            background-color: #333;
            color: #fff;
            border-color: #555;
        }
    </style>
</head>

<body>
    <div class="container-fluid py-4">
        <div
            class="header-section d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-3">
            <h2 class="mb-0 text-light fw-bold" style="letter-spacing: 1.5px; text-align: center;">ğŸ“ˆ ç•¶æ—¥å¤§æˆ¶å‹•å‘ï¼ˆè²·è³£è¶…ï¼‰</h2>

            <div class="d-flex align-items-center gap-2 flex-wrap justify-content-center justify-content-md-end">
                <label for="dateSelect" class="form-label mb-0 fw-bold">é¸æ“‡æ—¥æœŸï¼š</label>
                <select id="dateSelect" class="form-select w-auto text-center fw-bold shadow-sm border-primary">
                    <option value="">è¼‰å…¥ä¸­...</option>
                </select>
                <label for="limitSelect" class="form-label mb-0 fw-bold ms-2">é¡¯ç¤ºï¼š</label>
                <select id="limitSelect" class="form-select w-auto text-center fw-bold shadow-sm border-warning">
                    <option value="35">å‰ 35 å</option>
                    <option value="all">é¡¯ç¤ºå…¨éƒ¨</option>
                </select>
                <label for="sortSelect" class="form-label mb-0 fw-bold ms-2">æ’åºï¼š</label>
                <select id="sortSelect" class="form-select w-auto text-center fw-bold shadow-sm border-info">
                    <option value="val">ä¾ä¼°åƒ¹æ’å</option>
                    <option value="shares">ä¾è‚¡æ•¸æ’å</option>
                </select>
                <button id="downloadBtn" class="btn btn-outline-success fw-bold">â¬‡ï¸ ä¸‹è¼‰ Excel</button>
                <div class="input-group w-auto">
                    <input type="date" id="fetchDateInput" class="form-control fw-bold border-danger shadow"
                        title="å¦‚æœè¦æŠ“éå»çš„è³‡æ–™è«‹é¸æ“‡æ—¥æœŸ" />
                    <button id="fetchDataBtn" class="btn btn-danger fw-bold shadow">âš¡ å–å¾—å°è‚¡è³‡æ–™</button>
                </div>
                <button id="refreshBtn" class="btn btn-primary fw-bold">ğŸ”„ é‡æ–°æ•´ç†</button>
            </div>
        </div>

        <ul class="nav nav-pills mb-3 gap-2" id="marketTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active fw-bold fs-5 px-4" id="twse-tab" data-bs-toggle="tab"
                    data-bs-target="#twse" type="button" role="tab" aria-selected="true">ä¸Šå¸‚</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link fw-bold fs-5 px-4 border" id="tpex-tab" data-bs-toggle="tab"
                    data-bs-target="#tpex" type="button" role="tab" aria-selected="false">ä¸Šæ«ƒ</button>
            </li>
        </ul>

        <div class="tab-content" id="marketTabsContent">
            <div class="tab-pane fade show active" id="twse" role="tabpanel">
                <div class="text-center p-5" id="twse-loading">
                    <div class="spinner-border text-primary" role="status"></div>
                    <h4 class="mt-3 text-secondary" id="twse-loading-text">æ­£åœ¨åŠªåŠ›è¼‰å…¥è³‡æ–™...</h4>
                    <div class="progress mt-3 mx-auto" style="height: 20px; max-width: 400px; display: none;"
                        id="twse-progress-container">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                            id="twse-progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="table-wrapper" id="twse-content" style="display: none;"></div>
            </div>

            <div class="tab-pane fade" id="tpex" role="tabpanel">
                <div class="text-center p-5" id="tpex-loading">
                    <div class="spinner-border text-primary" role="status"></div>
                    <h4 class="mt-3 text-secondary" id="tpex-loading-text">æ­£åœ¨åŠªåŠ›è¼‰å…¥è³‡æ–™...</h4>
                    <div class="progress mt-3 mx-auto" style="height: 20px; max-width: 400px; display: none;"
                        id="tpex-progress-container">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                            id="tpex-progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="table-wrapper" id="tpex-content" style="display: none;"></div>
            </div>
        </div>

        <div class="mt-4" id="debugLogContainer" style="display: none;">
            <div class="card bg-dark border-secondary">
                <div
                    class="card-header border-secondary text-warning fw-bold d-flex justify-content-between align-items-center">
                    <span>âš™ï¸ åŸ·è¡Œæ—¥èªŒ (Debug Console)</span>
                    <button type="button" class="btn-close btn-close-white"
                        onclick="document.getElementById('debugLogContainer').style.display='none'"></button>
                </div>
                <div class="card-body p-0">
                    <pre class="m-0 p-3 text-light" id="debugLogOutput"
                        style="max-height: 250px; overflow-y: auto; font-size: 0.85rem; background: #111; border-radius: 0 0 5px 5px;">æš«ç„¡æ—¥èªŒï¼Œè«‹é»é¸ã€Œå–å¾—å°è‚¡è³‡æ–™ã€ç”¢ç”Ÿã€‚</pre>
                </div>
            </div>
        </div>


        <footer
            class="mt-5 pb-3 d-flex justify-content-between align-items-center flex-wrap gap-3 border-top border-secondary pt-4">
            <div>
                <a href="https://github.com/Aiersenlan/institutional-tracker" target="_blank"
                    class="text-decoration-none text-info fw-bold d-flex align-items-center disabled-selection">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                        class="bi bi-github me-2" viewBox="0 0 16 16">
                        <path
                            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
                    </svg>
                    Aiersenlan/institutional-tracker
                </a>
            </div>
            <div>
                <button class="btn btn-sm btn-outline-secondary fw-bold"
                    onclick="document.getElementById('debugLogContainer').style.display = document.getElementById('debugLogContainer').style.display === 'none' ? 'block' : 'none'">
                    âš™ï¸ é¡¯ç¤º/éš±è—åŸ·è¡Œæ—¥èªŒ
                </button>
            </div>
        </footer>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Back to Top Button -->
    <button id="backToTopBtn" class="btn btn-warning fw-bold rounded-circle shadow-lg"
        style="position: fixed; bottom: 30px; right: 30px; display: none; z-index: 1050; width: 50px; height: 50px; font-size: 20px; outline: none; border: none; align-items: center; justify-content: center;">â¬†ï¸</button>

    <script>
        let currentReportData = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadAvailableDates();

            const backToTopBtn = document.getElementById('backToTopBtn');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    backToTopBtn.style.display = 'flex';
                } else {
                    backToTopBtn.style.display = 'none';
                }
            });
            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            document.getElementById('dateSelect').addEventListener('change', (e) => {
                if (e.target.value) {
                    loadReport(e.target.value);
                }
            });

            document.getElementById('sortSelect').addEventListener('change', () => {
                renderBothTables();
            });

            document.getElementById('limitSelect').addEventListener('change', () => {
                renderBothTables();
            });

            document.getElementById('refreshBtn').addEventListener('click', () => {
                const currentDate = document.getElementById('dateSelect').value;
                if (currentDate) {
                    loadReport(currentDate);
                } else {
                    loadAvailableDates();
                }
            });

            document.getElementById('downloadBtn').addEventListener('click', () => {
                const currentDate = document.getElementById('dateSelect').value;
                if (currentDate) {
                    window.location.href = `/download/${currentDate}`;
                } else {
                    alert('è«‹å…ˆé¸æ“‡æ—¥æœŸ');
                }
            });

            // Set expected date automatically on the fetch input (Last valid trading day)
            const targetDateObj = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Taipei" }));
            // If before 3 PM, data usually not ready for today, shift to yesterday
            if (targetDateObj.getHours() < 15) {
                targetDateObj.setDate(targetDateObj.getDate() - 1);
            }
            // Skip weekends
            if (targetDateObj.getDay() === 0) targetDateObj.setDate(targetDateObj.getDate() - 2); // Sun -> Fri
            else if (targetDateObj.getDay() === 6) targetDateObj.setDate(targetDateObj.getDate() - 1); // Sat -> Fri

            const targetDateStr = targetDateObj.getFullYear() + "-" +
                String(targetDateObj.getMonth() + 1).padStart(2, '0') + "-" +
                String(targetDateObj.getDate()).padStart(2, '0');
            document.getElementById('fetchDateInput').value = targetDateStr;

            window.hasAutoFetched = false;

            document.getElementById('fetchDataBtn').addEventListener('click', async () => {
                const btn = document.getElementById('fetchDataBtn');
                const targetDate = document.getElementById('fetchDateInput').value; // format YYYY-MM-DD

                if (!targetDate) {
                    alert('è«‹é¸æ“‡æ‚¨è¦æŠ“å–çš„æ—¥æœŸï¼');
                    return;
                }

                const originalText = btn.innerHTML;

                // Set loading status
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> æ­£åœ¨é€£ç·šä¸­...';
                btn.disabled = true;

                let simProgress = 0;
                showLoading(true, 0, "æ­£åœ¨é€£ç·šäº¤æ˜“æ‰€èˆ‡çˆ¬å–è³‡æ–™ä¸­ï¼Œè«‹ç¨å€™...");
                const simInterval = setInterval(() => {
                    if (simProgress < 90) {
                        simProgress += Math.random() * 5 + 1;
                        if (simProgress > 90) simProgress = 90;
                        showLoading(true, simProgress, `çˆ¬èŸ²åŸ·è¡Œä¸­... ${Math.floor(simProgress)}%`);
                    }
                }, 400);

                try {
                    const res = await fetch('/trigger_analysis', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ date: targetDate })
                    });
                    const result = await res.json();

                    clearInterval(simInterval);
                    showLoading(true, 100, "è³‡æ–™è™•ç†å®Œæˆï¼æº–å‚™æ¸²æŸ“...");

                    document.getElementById('debugLogContainer').style.display = 'block';
                    document.getElementById('debugLogOutput').textContent = result.debug_log || 'ç„¡é¡å¤–æ—¥èªŒè³‡è¨Šã€‚';

                    if (res.ok) {
                        let okTimer = setTimeout(async () => {
                            showLoading(false);
                            await loadAvailableDates();
                        }, 600);
                    } else {
                        showLoading(false);
                        showError('âŒ éŒ¯èª¤ï¼š' + (result.message || 'æœªçŸ¥éŒ¯èª¤'));

                        // Fallback to loading whatever data we have
                        const select = document.getElementById('dateSelect');
                        if (select.options.length > 0 && select.value) {
                            loadReport(select.value || select.options[0].value);
                        }
                    }
                } catch (error) {
                    clearInterval(simInterval);
                    showLoading(false);
                    showError('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æ˜¯è¯çµ¡ç³»çµ±ç®¡ç†å“¡ã€‚\n' + error);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        });

        async function loadAvailableDates() {
            try {
                const res = await fetch('/get_available_dates');
                const data = await res.json();

                const select = document.getElementById('dateSelect');
                select.innerHTML = '';

                if (data.dates && data.dates.length > 0) {
                    data.dates.forEach(date => {
                        const formatted = `${date.substring(0, 4)}/${date.substring(4, 6)}/${date.substring(6, 8)}`;
                        const option = document.createElement('option');
                        option.value = date;
                        option.textContent = formatted;
                        select.appendChild(option);
                    });

                    const expectedStrYYYYMMDD = document.getElementById('fetchDateInput').value.replace(/-/g, '');

                    // Auto fetch logic if expected date not found
                    if (!data.dates.includes(expectedStrYYYYMMDD) && !window.hasAutoFetched) {
                        window.hasAutoFetched = true;
                        console.log("Expected report not found. Auto-fetching...");
                        document.getElementById('fetchDataBtn').click();
                    } else {
                        // Load expected date if found, otherwise latest available
                        const dateToLoad = data.dates.includes(expectedStrYYYYMMDD) ? expectedStrYYYYMMDD : data.dates[0];
                        select.value = dateToLoad;
                        loadReport(dateToLoad);
                    }
                } else {
                    select.innerHTML = '<option value="">ç„¡å¯ç”¨å ±è¡¨</option>';
                    if (!window.hasAutoFetched) {
                        window.hasAutoFetched = true;
                        document.getElementById('fetchDataBtn').click();
                    } else {
                        showError('æœªæ‰¾åˆ°ä»»ä½•å ±è¡¨æª”æ¡ˆã€‚è«‹ç¢ºå®šæœ‰å…ˆåŸ·è¡Œ analyze.py ç”¢å‡ºæª”æ¡ˆã€‚');
                    }
                }
            } catch (error) {
                console.error('Error fetching dates:', error);
                showError('ç„¡æ³•è¼‰å…¥æ—¥æœŸåˆ—è¡¨');
            }
        }

        async function loadReport(dateStr) {
            showLoading(true);
            try {
                const res = await fetch(`/get_report/${dateStr}`);
                if (!res.ok) throw new Error('å ±è¡¨è®€å–å¤±æ•—');
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                currentReportData = data;
                renderBothTables();

                showLoading(false);
            } catch (error) {
                console.error('Error loading report:', error);
                showError('è¼‰å…¥å ±è¡¨å…§å®¹æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                showLoading(false);
            }
        }

        function renderBothTables() {
            if (!currentReportData) return;
            const sortMode = document.getElementById('sortSelect').value;
            const limitMode = document.getElementById('limitSelect').value;
            renderTable('twse-content', currentReportData['ä¸Šå¸‚'], sortMode, limitMode);
            renderTable('tpex-content', currentReportData['ä¸Šæ«ƒ'], sortMode, limitMode);
        }

        function showLoading(isLoading, percent = null, text = "æ­£åœ¨åŠªåŠ›è¼‰å…¥è³‡æ–™...") {
            document.getElementById('twse-loading').style.display = isLoading ? 'block' : 'none';
            document.getElementById('twse-content').style.display = isLoading ? 'none' : 'block';
            document.getElementById('tpex-loading').style.display = isLoading ? 'block' : 'none';
            document.getElementById('tpex-content').style.display = isLoading ? 'none' : 'block';

            if (isLoading) {
                document.getElementById('twse-loading-text').textContent = text;
                document.getElementById('tpex-loading-text').textContent = text;

                if (percent !== null) {
                    document.getElementById('twse-progress-container').style.display = 'block';
                    document.getElementById('twse-progress-bar').style.width = percent + '%';
                    document.getElementById('tpex-progress-container').style.display = 'block';
                    document.getElementById('tpex-progress-bar').style.width = percent + '%';
                } else {
                    document.getElementById('twse-progress-container').style.display = 'none';
                    document.getElementById('tpex-progress-container').style.display = 'none';
                }
            }
        }

        function showError(msg) {
            document.getElementById('twse-content').innerHTML = `<div class="alert alert-danger">${msg}</div>`;
            document.getElementById('tpex-content').innerHTML = `<div class="alert alert-danger">${msg}</div>`;
            document.getElementById('twse-content').style.display = 'block';
            document.getElementById('tpex-content').style.display = 'block';
            document.getElementById('twse-loading').style.display = 'none';
            document.getElementById('tpex-loading').style.display = 'none';
        }

        function formatNumber(num, decimals = 0) {
            if (num === '' || num === null || num === undefined) return '';
            // If it's a number, format it with commas
            if (!isNaN(num) && typeof num === 'number') {
                return Number(num).toLocaleString('en-US', {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                });
            }
            return num;
        }

        function renderTable(containerId, sheetData, sortMode = 'val', limitMode = '35') {
            if (!sheetData) {
                document.getElementById(containerId).innerHTML = '<div class="alert alert-warning">æ²’æœ‰è³‡æ–™</div>';
                return;
            }

            // The exact layout relies on us finding related stocks in rows and knowing which columns represent what.
            // Based on our Python logic:
            // Col 1,2: å¤–è³‡è²·è¶… (0-5)
            // Col 3: empty
            // Col 8,9: å¤–è³‡è³£è¶… (7-12)
            // Col 15,16: æŠ•ä¿¡è²·è¶… (14-19)
            // Col 22,23: æŠ•ä¿¡è³£è¶… (21-26)

            // To make HTML perfectly styled like the Excel, we need to apply coloring logic in JS based on the data.
            // Since we don't have the stock_state here directly, we will reconstruct it exactly as the python script did:

            // Re-calculate the states for the view.
            // Note: The python script does exact same coloring. 
            // In the data we provided via JSON, we only have raw values. 
            // Let's build a quick map of Code -> {f_val, i_val} to determine colors!

            // 1. Extract valid blocks for sorting
            let fb_list = []; let fs_list = []; let ib_list = []; let is_list = [];
            sheetData.data.forEach(row => {
                if (row[0] !== '') fb_list.push(row.slice(0, 6));
                if (row[7] !== '') fs_list.push(row.slice(7, 13));
                if (row[14] !== '') ib_list.push(row.slice(14, 20));
                if (row[21] !== '') is_list.push(row.slice(21, 27));
            });

            // 2. Sorting function
            const sortFn = (a, b) => {
                // val is index 5, shares is index 4
                const a_val = Number(a[sortMode === 'val' ? 5 : 4]) || 0;
                const b_val = Number(b[sortMode === 'val' ? 5 : 4]) || 0;
                return Math.abs(b_val) - Math.abs(a_val);
            };

            fb_list.sort(sortFn);
            fs_list.sort(sortFn);
            ib_list.sort(sortFn);
            is_list.sort(sortFn);

            // 3. Apply limits
            if (limitMode === '35') {
                fb_list = fb_list.slice(0, 35);
                fs_list = fs_list.slice(0, 35);
                ib_list = ib_list.slice(0, 35);
                is_list = is_list.slice(0, 35);
            }

            // 4. Build a map restricted to only visible stock rows to determine colors
            const stockDataMap = new Map();
            const trackStock = (code, shares, isForeign) => {
                if (!code || code === '') return;
                const key = String(code);
                const ex = stockDataMap.get(key) || {};
                if (isForeign) ex.f_val = Number(shares);
                else ex.i_val = Number(shares);
                stockDataMap.set(key, ex);
            };
            fb_list.forEach(r => trackStock(r[0], r[4], true));
            fs_list.forEach(r => trackStock(r[0], r[4], true));
            ib_list.forEach(r => trackStock(r[0], r[4], false));
            is_list.forEach(r => trackStock(r[0], r[4], false));

            // Determine state colors
            function getFillClass(code, isForeignInfo) {
                if (!code) return '';
                const d = stockDataMap.get(String(code));
                if (!d) return '';

                const f_val = d.f_val || 0;
                const i_val = d.i_val || 0;

                // Color only applies if BOTH sides are currently visible in the sliced data
                if (f_val === 0 || i_val === 0) return '';

                if ((f_val > 0 && i_val > 0) || (f_val < 0 && i_val < 0)) {
                    if (Math.abs(f_val) > Math.abs(i_val)) {
                        return isForeignInfo ? 'bg-red-dark' : 'bg-red-light';
                    } else if (Math.abs(f_val) < Math.abs(i_val)) {
                        return isForeignInfo ? 'bg-red-light' : 'bg-red-dark';
                    } else {
                        return 'bg-red-light';
                    }
                } else if ((f_val > 0 && i_val < 0) || (f_val < 0 && i_val > 0)) {
                    if (Math.abs(f_val) > Math.abs(i_val)) {
                        return isForeignInfo ? 'bg-green-dark' : 'bg-green-light';
                    } else {
                        return isForeignInfo ? 'bg-green-light' : 'bg-green-dark';
                    }
                }
                return '';
            }

            // Determine max rows
            const maxRows = Math.max(fb_list.length, fs_list.length, ib_list.length, is_list.length);

            // Reconstruct sorted rows
            const sortedRows = [];
            for (let i = 0; i < maxRows; i++) {
                const newRow = new Array(27).fill('');
                if (i < fb_list.length) fb_list[i].forEach((v, idx) => newRow[idx] = v);
                if (i < fs_list.length) fs_list[i].forEach((v, idx) => newRow[idx + 7] = v);
                if (i < ib_list.length) ib_list[i].forEach((v, idx) => newRow[idx + 14] = v);
                if (i < is_list.length) is_list[i].forEach((v, idx) => newRow[idx + 21] = v);
                sortedRows.push(newRow);
            }

            let html = '<table class="table table-bordered table-dark table-hover table-sm align-middle">';

            // Main Headers
            html += '<thead><tr>';
            html += `<th colspan="6" class="fs-5 shadow-sm th-buy">å¤–è³‡è²·è¶…</th><th class="border-0 bg-transparent"></th>`;
            html += `<th colspan="6" class="fs-5 shadow-sm th-sell">å¤–è³‡è³£è¶…</th><th class="border-0 bg-transparent"></th>`;
            html += `<th colspan="6" class="fs-5 shadow-sm th-buy">æŠ•ä¿¡è²·è¶…</th><th class="border-0 bg-transparent"></th>`;
            html += `<th colspan="6" class="fs-5 shadow-sm th-sell">æŠ•ä¿¡è³£è¶…</th>`;
            html += '</tr><tr class="sub-header">';

            // Sub Headers
            const sub = sheetData.sub_headers;
            for (let i = 0; i < 4; i++) {
                html += `
                    <th>${sub[0]}</th>
                    <th>${sub[1]}</th>
                    <th>${sub[2]}</th>
                    <th>${sub[3]}</th>
                    <th>${sub[4]}</th>
                    <th>${sub[5]}</th>
                `;
                if (i < 3) html += '<th class="border-0 bg-transparent px-1"></th>';
            }
            html += '</tr></thead><tbody>';

            // Data Rows
            sortedRows.forEach(row => {
                html += '<tr>';

                // Block builder
                const buildBlock = (startIndex, isForeign) => {
                    const code = row[startIndex];
                    const name = row[startIndex + 1];
                    const price = row[startIndex + 2];
                    const vwap = row[startIndex + 3];
                    const shares = row[startIndex + 4];
                    const val = row[startIndex + 5];

                    if (code === '') {
                        return `<td></td><td></td><td></td><td></td><td></td><td></td>`;
                    }

                    const fillClass = getFillClass(code, isForeign);

                    return `
                        <td class="text-center font-monospace">${code}</td>
                        <td class="text-center fw-bold stock-clickable ${fillClass}" data-code="${code}" onclick="scrollToStock('${code}', this)" onmouseover="highlightStock('${code}')" onmouseout="removeHighlightStock('${code}')" title="é»æ“Šè·³è½‰åˆ°å¦ä¸€å€‹è²·è³£è¶…å€åŸŸ">${name}</td>
                        <td class="stock-data-${code}">${formatNumber(price, 2)}</td>
                        <td class="stock-data-${code}">${formatNumber(vwap, 2)}</td>
                        <td class="stock-data-${code}">${formatNumber(shares, 0)}</td>
                        <td class="fw-bold stock-data-${code}">${formatNumber(val, 2)}</td>
                    `;
                };

                // Foreign Buy (0-5)
                html += buildBlock(0, true);
                html += '<td class="border-0"></td>';
                // Foreign Sell (7-12)
                html += buildBlock(7, true);
                html += '<td class="border-0"></td>';
                // IT Buy (14-19)
                html += buildBlock(14, false);
                html += '<td class="border-0"></td>';
                // IT Sell (21-26)
                html += buildBlock(21, false);

                html += '</tr>';
            });

            html += '</tbody></table>';
            document.getElementById(containerId).innerHTML = html;
        }

        function highlightStock(code) {
            document.querySelectorAll(`.stock-data-${code}`).forEach(el => el.classList.add('hover-bg-yellow'));
            document.querySelectorAll(`.stock-clickable[data-code="${code}"]`).forEach(el => {
                el.style.boxShadow = "inset 0 0 0 2px #ffc107";
            });
        }

        function removeHighlightStock(code) {
            document.querySelectorAll(`.stock-data-${code}`).forEach(el => el.classList.remove('hover-bg-yellow'));
            document.querySelectorAll(`.stock-clickable[data-code="${code}"]`).forEach(el => {
                el.style.boxShadow = "";
            });
        }

        function scrollToStock(code, currentEl) {
            const nodes = Array.from(document.querySelectorAll(`.stock-clickable[data-code="${code}"]`));
            if (nodes.length <= 1) return;

            const currentIndex = nodes.indexOf(currentEl);
            const nextIndex = (currentIndex + 1) % nodes.length;
            const targetEl = nodes[nextIndex];

            targetEl.scrollIntoView({ behavior: "smooth", block: "center", inline: "center" });

            // Flash effect prominently in the center mapping to "é®®æ˜é»ƒè‰²æ¡†"
            const originalBg = targetEl.style.backgroundColor;
            const originalColor = targetEl.style.color;
            const originalBoxShadow = targetEl.style.boxShadow;
            const originalZIndex = targetEl.style.zIndex;

            targetEl.style.transition = 'all 0.3s ease';
            targetEl.style.backgroundColor = '#ffff00';
            targetEl.style.color = '#000000';
            targetEl.style.boxShadow = '0 0 0 4px #ff0000, 0 0 20px 10px #ffff00';
            targetEl.style.zIndex = '1000';
            targetEl.style.position = 'relative';

            setTimeout(() => {
                targetEl.style.backgroundColor = originalBg;
                targetEl.style.color = originalColor;
                targetEl.style.boxShadow = originalBoxShadow;
                targetEl.style.transition = 'background-color 0.2s';
                targetEl.style.zIndex = originalZIndex;
            }, 2000);
        }
    </script>
</body>

</html>